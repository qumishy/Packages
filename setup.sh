#!/bin/bash

# =========================================================
# ูุชุบูุฑุงุช ุงูุชุฎุตูุต
# ูุฌุจ ุนููู ุชุญุฏูุซ ูุฐู ุงูููู ูุจู ุชุดุบูู ุงูุณูุฑุจุช
# =========================================================
IMAGEBUILDER_DIR="openwrt-imagebuilder-23.05.6-ramips-mt7621.Linux-x86_64"  # ุนุฏูู ูุฐุง ุงูุงุณู ููุชุทุงุจู ูุน ุงุณู ูุฌูุฏ ImageBuilder ุงููุนูู
CUSTOM_HOSTNAME="ุงุจู ุนูุงุถ"
PHONE_NUMBER="774372146"
LOGO_SOURCE="m.jpg" # ุชุฃูุฏ ูู ุฃู ูุฐู ุงูุตูุฑุฉ ููุฌูุฏุฉ ูู ููุณ ูุฌูุฏ ุงูุณูุฑุจุช
LOGO_DEST_NAME="logo.png"

# =========================================================
# ุงูุชุญูู ูู ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ
# =========================================================
if [ ! -d "$IMAGEBUILDER_DIR" ]; then
    echo "โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฌูุฏ ImageBuilder ุจุงุณู: $IMAGEBUILDER_DIR"
    echo "ูุฑุฌู ุชุนุฏูู ูููุฉ IMAGEBUILDER_DIR ูู ุงูุณูุฑุจุช ููุชุทุงุจู ูุน ุงุณู ูุฌูุฏู ุงููุนูู."
    exit 1
fi

if [ ! -f "$LOGO_SOURCE" ]; then
    echo "โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุงูุนุซูุฑ ุนูู ููู ุงูููุฌู ($LOGO_SOURCE). ุณูุชู ุฅูุดุงุก ุงููุณุงุฑุงุช ูููู ูู ูุชู ูุณุฎ ุงูููุฌู."
    echo "ูุฑุฌู ุงูุชุฃูุฏ ูู ูุถุน ุตูุฑุชู (m.jpg) ูู ููุณ ุงููุฌูุฏ ูุจู ุงูุชุดุบูู."
fi

echo "๐ ุจุฏุก ุฅุนุฏุงุฏ ูููู ูููุงุช ุงูุชุฎุตูุต ุฏุงุฎู: $IMAGEBUILDER_DIR"
cd "$IMAGEBUILDER_DIR"

# =========================================================
# 1. ุฅูุดุงุก ูููู ุงููุฌูุฏุงุช files/
# =========================================================
echo "ุฅูุดุงุก ูููู ุงููุฌูุฏุงุช..."
mkdir -p files/etc/config
mkdir -p files/etc
mkdir -p files/usr/lib/lua/luci/{controller,view}
mkdir -p files/www/luci-static/argon/img

# =========================================================
# 2. ุฅูุดุงุก ูุชุนุฏูู ูููุงุช ุงูุฅุนุฏุงุฏุงุช (Hostname & Banner)
# =========================================================
echo "ุชุทุจูู ุชุนุฏููุงุช ุงูุงุณู ูุฑูู ุงููุงุชู..."

# a) ุชุนุฏูู ุงุณู ุงููุถูู (Hostname) ูู /etc/config/system
cat > files/etc/config/system << EOF
config system
    option hostname '$CUSTOM_HOSTNAME'
    option timezone 'UTC'
    # ููููู ุฅุถุงูุฉ ุฃู ุฎูุงุฑุงุช ูุธุงู ุงูุชุฑุงุถูุฉ ุฃุฎุฑู ููุง
EOF
echo "โ ุชู ุฅูุดุงุก ููู files/etc/config/system ุจุงูุงุณู ุงูุฌุฏูุฏ."

# b) ุฅุถุงูุฉ ุฑูู ุงููุงุชู ูู ููู Banner
echo -e "ูุฑุญุจูุง ุจู ูู ูุธุงู $CUSTOM_HOSTNAME ุงููุฎุตุต.\nููุชูุงุตู ูุงูุฏุนู: $PHONE_NUMBER" > files/etc/banner
echo "โ ุชู ุฅูุดุงุก ููู files/etc/banner."

# =========================================================
# 3. ุฅูุดุงุก ูููุงุช ุตูุญุฉ "ุญูููุง" (LuCI Controller & View)
# =========================================================
echo "ุฅุถุงูุฉ ุตูุญุฉ 'ุญูููุง' ุฅูู LuCI..."

# a) LuCI Controller: ูุถูู ุงูุตูุญุฉ ุฅูู ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ (ุงูุชุฑุชูุจ 90)
cat > files/usr/lib/lua/luci/controller/about.lua << EOF
module("luci.controller.about", package.seeall)

function index()
    entry({"admin", "about"}, call("action_about"), _("About Us"), 90).leaf = true
end

function action_about()
    luci.template.render("about_page")
end
EOF
echo "โ ุชู ุฅูุดุงุก ููู Controller (about.lua)."

# b) LuCI View: ูุญุชูู ุตูุญุฉ "ุญูููุง"
cat > files/usr/lib/lua/luci/view/about_page.htm << EOF
<%+header%>
<h2><%:ุญูู ูุธุงู $CUSTOM_HOSTNAME%></h2>
<div class="cbi-map-descr">
    <p>ุชู ุจูุงุก ูุฐุง ุงููุธุงู ุฎุตูุตุงู ูู <strong>$CUSTOM_HOSTNAME</strong>.</p>
    <p>ููุฏุนู ุงูููู ูุงูุงุณุชูุณุงุฑุงุชุ ูุฑุฌู ุงูุงุชุตุงู ุนูู ุงูุฑูู: <strong>$PHONE_NUMBER</strong></p>
</div>
<%+footer%>
EOF
echo "โ ุชู ุฅูุดุงุก ููู View (about_page.htm)."

# =========================================================
# 4. ูุณุฎ ููู ุงูููุฌู
# =========================================================
if [ -f "../$LOGO_SOURCE" ]; then
    cp "../$LOGO_SOURCE" "files/www/luci-static/argon/img/$LOGO_DEST_NAME"
    echo "โ ุชู ูุณุฎ ุงูููุฌู ($LOGO_SOURCE) ูุชุณููุชู ($LOGO_DEST_NAME)."
else
    echo "โ ูู ูุชู ูุณุฎ ุงูููุฌู. ุณูุชู ุงุณุชุฎุฏุงู ุงูููุฌู ุงูุงูุชุฑุงุถู ูุซูู Argon."
fi

# =========================================================
# 5. ุงูุชูุฌูู ูุฎุทูุฉ ุงูุจูุงุก
# =========================================================
echo "========================================================="
echo "โ ุงูุชูู ุฅุนุฏุงุฏ ุงููููุงุช ุจูุฌุงุญ!"
echo "ุงูุขูุ ููููู ุชุดุบูู ุฃูุฑ ุงูุจูุงุก ุงูุณุฑูุน ImageBuilder:"
echo ""
echo "make image PROFILE=\"[ุงุณู ุงูุฌูุงุฒ]\" PACKAGES=\"luci luci-theme-argon -ppp -ppp-mod-pppoe\" FILES=\"files/\""
echo ""
echo "ูุง ุชูุณ ุงุณุชุจุฏุงู [ุงุณู ุงูุฌูุงุฒ] ุจููู ุชุนุฑูู ุฌูุงุฒู ุงููุนูู."
echo "========================================================="
